# AstrBot Chat Pro Plugin 🌟

一个简洁高效的 AstrBot 插件，支持 LLM 通过 `[recall]` 标记自主撤回消息。

## 功能特性 ✨

### LLM 自主撤回 🔄
- AI 只需在消息末尾添加 `[recall]` 标记
- 消息发送后自动撤回（延迟约0.5秒）
- `[recall]` 标记会被自动移除，不会显示在消息中
- 无需复杂配置，开箱即用

## 快速开始 🚀

### 1. 安装插件
将插件放入 AstrBot 的插件目录并启用。

### 2. 配置 AI 人格
在你的 AI 人格提示词中添加：

```
当你需要撤回消息时，在消息末尾添加 [recall] 标记。
例如："我爱你[recall]" 会先发送"我爱你"，然后立即撤回。
```

### 3. 使用示例

**场景1：发送错误信息后撤回**
```
用户：1+1等于几？
AI：1+1等于3[recall]
[消息"1+1等于3"被发送后立即撤回]
AI：抱歉，1+1等于2
```

**场景2：临时展示信息**
```
用户：给我看看你的思考过程
AI：让我想想...（分析中）[recall]
[消息被展示后撤回]
AI：我已经想好了，答案是...
```

## 工作原理 🔧

1. **检测标记**：`@filter.on_decorating_result()` 钩子在消息发送前检测 `[recall]`
2. **清理内容**：自动移除 `[recall]` 标记，只发送实际内容
3. **标记撤回**：在 event 对象上设置 `_need_recall` 标志
4. **执行撤回**：`@filter.after_message_sent()` 钩子检测标志并执行撤回
5. **获取ID**：从 `result.metadata` 或 `event.message_obj` 获取 message_id
6. **调用API**：使用 `delete_msg` API 撤回消息

## 技术细节 🔍

### 核心实现
- 使用正则表达式不区分大小写匹配 `[recall]`
- 修改消息链中的 Plain 组件文本
- 异步延迟0.5秒确保消息已发送
- 完善的错误处理和日志记录

### 平台支持
- ✅ QQ (通过 aiocqhttp)
- ⏳ 其他平台开发中...

### 命令列表
- `/recall_help` - 显示使用帮助

## 配置示例 📋

### 基础配置
在 AI 人格的 system_prompt 中添加：
```
你拥有撤回消息的能力。在消息末尾添加 [recall] 即可撤回该消息。
```

### 详细配置
```
你拥有撤回消息的能力，使用方法：

在消息末尾添加 [recall] 标记，消息会被发送后立即撤回。

使用场景：
1. 发送了错误或不准确的信息
2. 需要临时展示某些内容后删除
3. 测试功能后立即清理

示例：
- "我爱你[recall]" → 发送"我爱你"后立即撤回
- "答案是42[recall]" → 发送"答案是42"后立即撤回

注意：
- [recall] 标记不会显示在消息中
- 只有在真正需要时才使用撤回功能
- 撤回会有约0.5秒的延迟
```

## 故障排除 🔧

### 常见问题

**Q: 撤回功能不工作？**
A: 请检查：
1. 确保使用的是 QQ 平台（aiocqhttp）
2. 确认机器人有撤回消息的权限
3. 查看 AstrBot 日志中是否有报错信息
4. 确认消息格式正确（Plain 文本组件）

**Q: 如何查看调试日志？**
A: 在 AstrBot 日志中搜索以下关键词：
- "检测到 [recall] 标记"
- "将发送并撤回消息"
- "成功撤回消息"
- "撤回消息失败"

**Q: 为什么有时撤回失败？**
A: 可能的原因：
- 消息已超过平台撤回时间限制（通常2分钟）
- 无法正确获取 message_id
- 网络延迟或API调用失败
- 机器人权限不足

**Q: [recall] 标记会被发送出去吗？**
A: 不会！插件会在发送前自动移除 `[recall]` 标记，只发送实际内容。

## 更新日志 📅

### v1.0.1 (2026-01-14)
- 🔧 修复导入路径错误
- 🔧 修正构造函数签名，添加 config 参数
- ✨ 参考 outputpro 插件优化代码结构
- 📝 简化功能，移除不必要的命令
- 📖 更新文档说明

### v1.0.0 (2026-01-14)
- ✨ 首次发布
- ✅ 支持通过 `[recall]` 标记撤回消息
- ✅ 自动移除标记保持消息整洁
- ✅ 完善的错误处理

## 贡献 🤝

欢迎提交 Issue 和 Pull Request！

## 许可证 📄

MIT License

## 作者 ✍️

- **Twinkle**
- GitHub: [joy040216-create](https://github.com/joy040216-create)

## 致谢 🙏

感谢 [AstrBot](https://github.com/AstrBotDevs/AstrBot) 团队提供的优秀框架！

---

如有问题或建议，欢迎在 [GitHub Issues](https://github.com/joy040216-create/astrbot_plugin_chat_pro/issues) 中反馈。
